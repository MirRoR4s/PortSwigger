<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bypassing CSRF token validation &mdash; PortSwigger 0.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=44496db0"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PortSwigger
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">服务端</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../server/race_conditions.html">条件竞争</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">客户端</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../xss/cross-site-scripting.html">Cross-site scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="csrf.html">Cross-site request forgery (CSRF)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cors/cors.html">Cross-origin resource sharing (CORS)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PortSwigger</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Bypassing CSRF token validation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/source/client/csrf/bypassing-csrf-token-validation.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="bypassing-csrf-token-validation">
<h1><a class="reference external" href="https://portswigger.net/web-security/csrf/bypassing-token-validation">Bypassing CSRF token validation</a><a class="headerlink" href="#bypassing-csrf-token-validation" title="Permalink to this heading"></a></h1>
<p>In this section, we’ll explain what CSRF tokens are, how they protect against CSRF attacks, and how you can potentially bypass these defenses.</p>
<section id="what-is-a-csrf-token">
<h2>What is a CSRF token?<a class="headerlink" href="#what-is-a-csrf-token" title="Permalink to this heading"></a></h2>
<p>A CSRF token is a unique, secret, and unpredictable value that is generated by the server-side application and shared with the client. When issuing a request to perform a sensitive action, such as submitting a form, the client must include the correct CSRF token. Otherwise, the server will refuse to perform the requested action.</p>
<p>A common way to share CSRF tokens with the client is to include them as a hidden parameter in an HTML form, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">form</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;change-email-form&quot;</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/my-account/change-email&quot;</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="o">&gt;</span>    <span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="n">Email</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>    <span class="o">&lt;</span><span class="nb">input</span> <span class="n">required</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;email&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;email&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;example@normal-website.com&quot;</span><span class="o">&gt;</span>    <span class="o">&lt;</span><span class="nb">input</span> <span class="n">required</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;csrf&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;50FaWgdOhi9M9wyna8taR1k3ODOR8d6u&quot;</span><span class="o">&gt;</span>    <span class="o">&lt;</span><span class="n">button</span> <span class="n">class</span><span class="o">=</span><span class="s1">&#39;button&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;submit&#39;</span><span class="o">&gt;</span> <span class="n">Update</span> <span class="n">email</span> <span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Submitting this form results in the following request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">account</span><span class="o">/</span><span class="n">change</span><span class="o">-</span><span class="n">email</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">Host</span><span class="p">:</span> <span class="n">normal</span><span class="o">-</span><span class="n">website</span><span class="o">.</span><span class="n">com</span> <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">70</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span> <span class="n">csrf</span><span class="o">=</span><span class="mi">50</span><span class="n">FaWgdOhi9M9wyna8taR1k3ODOR8d6u</span><span class="o">&amp;</span><span class="n">email</span><span class="o">=</span><span class="n">example</span><span class="nd">@normal</span><span class="o">-</span><span class="n">website</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>When implemented correctly, CSRF tokens help protect against CSRF attacks by making it difficult for an attacker to construct a valid request on behalf of the victim. As the attacker has no way of predicting the correct value for the CSRF token, they won’t be able to include it in the malicious request.</p>
<section id="note">
<h3>Note<a class="headerlink" href="#note" title="Permalink to this heading"></a></h3>
<p>CSRF tokens don’t have to be sent as hidden parameters in a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request. Some applications place CSRF tokens in HTTP headers, for example. The way in which tokens are transmitted has a significant impact on the security of a mechanism as a whole. For more information, see <a class="reference external" href="https://portswigger.net/web-security/csrf/preventing">How to prevent CSRF vulnerabilities</a>.</p>
</section>
</section>
<section id="common-flaws-in-csrf-token-validation">
<h2>Common flaws in CSRF token validation<a class="headerlink" href="#common-flaws-in-csrf-token-validation" title="Permalink to this heading"></a></h2>
<p>CSRF vulnerabilities typically arise due to flawed validation of CSRF tokens. In this section, we’ll cover some of the most common issues that enable attackers to bypass these defenses.</p>
<section id="validation-of-csrf-token-depends-on-request-method">
<h3>Validation of CSRF token depends on request method<a class="headerlink" href="#validation-of-csrf-token-depends-on-request-method" title="Permalink to this heading"></a></h3>
<p>Some applications correctly validate the token when the request uses the POST method but skip the validation when the GET method is used.</p>
<p>In this situation, the attacker can switch to the GET method to bypass the validation and deliver a <a class="reference external" href="https://portswigger.net/web-security/csrf">CSRF attack</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GET /email/change?email=pwned@evil-user.net HTTP/1.1 Host: vulnerable-website.com Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm
</pre></div>
</div>
<p><strong>LAB</strong></p>
<p>PRACTITIONER<a class="reference external" href="https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-validation-depends-on-request-method">CSRF where token validation depends on request method</a></p>
</section>
<section id="validation-of-csrf-token-depends-on-token-being-present">
<h3>Validation of CSRF token depends on token being present<a class="headerlink" href="#validation-of-csrf-token-depends-on-token-being-present" title="Permalink to this heading"></a></h3>
<p>Some applications correctly validate the token when it is present but skip the validation if the token is omitted.</p>
<p>In this situation, the attacker can remove the entire parameter containing the token (not just its value) to bypass the validation and deliver a CSRF attack:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">email</span><span class="o">/</span><span class="n">change</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">Host</span><span class="p">:</span> <span class="n">vulnerable</span><span class="o">-</span><span class="n">website</span><span class="o">.</span><span class="n">com</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span> <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">25</span> <span class="n">Cookie</span><span class="p">:</span> <span class="n">session</span><span class="o">=</span><span class="mi">2</span><span class="n">yQIDcpia41WrATfjPqvm9tOkDvkMvLm</span> <span class="n">email</span><span class="o">=</span><span class="n">pwned</span><span class="nd">@evil</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
<p><strong>LAB</strong></p>
<p>PRACTITIONER<a class="reference external" href="https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-validation-depends-on-token-being-present">CSRF where token validation depends on token being present</a></p>
</section>
<section id="csrf-token-is-not-tied-to-the-user-session">
<h3>CSRF token is not tied to the user session<a class="headerlink" href="#csrf-token-is-not-tied-to-the-user-session" title="Permalink to this heading"></a></h3>
<p>Some applications do not validate that the token belongs to the same session as the user who is making the request. Instead, the application maintains a global pool of tokens that it has issued and accepts any token that appears in this pool.</p>
<p>In this situation, the attacker can log in to the application using their own account, obtain a valid token, and then feed that token to the victim user in their CSRF attack.</p>
<p><strong>LAB</strong></p>
<p>PRACTITIONER<a class="reference external" href="https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-not-tied-to-user-session">CSRF where token is not tied to user session</a></p>
</section>
<section id="csrf-token-is-tied-to-a-non-session-cookie">
<h3>CSRF token is tied to a non-session cookie<a class="headerlink" href="#csrf-token-is-tied-to-a-non-session-cookie" title="Permalink to this heading"></a></h3>
<p>In a variation on the preceding vulnerability, some applications do tie the CSRF token to a cookie, but not to the same cookie that is used to track sessions. This can easily occur when an application employs two different frameworks, one for session handling and one for CSRF protection, which are not integrated together:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">email</span><span class="o">/</span><span class="n">change</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">Host</span><span class="p">:</span> <span class="n">vulnerable</span><span class="o">-</span><span class="n">website</span><span class="o">.</span><span class="n">com</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span> <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">68</span> <span class="n">Cookie</span><span class="p">:</span> <span class="n">session</span><span class="o">=</span><span class="n">pSJYSScWKpmC60LpFOAHKixuFuM4uXWF</span><span class="p">;</span> <span class="n">csrfKey</span><span class="o">=</span><span class="n">rZHCnSzEp8dbI6atzagGoSYyqJqTz5dv</span> <span class="n">csrf</span><span class="o">=</span><span class="n">RhV7yQDO0xcq9gLEah2WVbmuFqyOq7tY</span><span class="o">&amp;</span><span class="n">email</span><span class="o">=</span><span class="n">wiener</span><span class="nd">@normal</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>This situation is harder to exploit but is still vulnerable. If the web site contains any behavior that allows an attacker to set a cookie in a victim’s browser, then an attack is possible. The attacker can log in to the application using their own account, obtain a valid token and associated cookie, leverage the cookie-setting behavior to place their cookie into the victim’s browser, and feed their token to the victim in their CSRF attack.</p>
<p><strong>LAB</strong></p>
<p>PRACTITIONER<a class="reference external" href="https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-tied-to-non-session-cookie">CSRF where token is tied to non-session cookie</a></p>
<section id="id1">
<h4>Note<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h4>
<p>The cookie-setting behavior does not even need to exist within the same web application as the <a class="reference external" href="https://portswigger.net/web-security/csrf">CSRF vulnerability</a>. Any other application within the same overall DNS domain can potentially be leveraged to set cookies in the application that is being targeted, if the cookie that is controlled has suitable scope. For example, a cookie-setting function on <code class="docutils literal notranslate"><span class="pre">staging.demo.normal-website.com</span></code> could be leveraged to place a cookie that is submitted to <code class="docutils literal notranslate"><span class="pre">secure.normal-website.com</span></code>.</p>
</section>
</section>
<section id="csrf-token-is-simply-duplicated-in-a-cookie">
<h3>CSRF token is simply duplicated in a cookie<a class="headerlink" href="#csrf-token-is-simply-duplicated-in-a-cookie" title="Permalink to this heading"></a></h3>
<p>In a further variation on the preceding vulnerability, some applications do not maintain any server-side record of tokens that have been issued, but instead duplicate each token within a cookie and a request parameter. When the subsequent request is validated, the application simply verifies that the token submitted in the request parameter matches the value submitted in the cookie. This is sometimes called the “double submit” defense against CSRF, and is advocated because it is simple to implement and avoids the need for any server-side state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">email</span><span class="o">/</span><span class="n">change</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">Host</span><span class="p">:</span> <span class="n">vulnerable</span><span class="o">-</span><span class="n">website</span><span class="o">.</span><span class="n">com</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span> <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">68</span> <span class="n">Cookie</span><span class="p">:</span> <span class="n">session</span><span class="o">=</span><span class="mi">1</span><span class="n">DQGdzYbOJQzLP7460tfyiv3do7MjyPw</span><span class="p">;</span> <span class="n">csrf</span><span class="o">=</span><span class="n">R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa</span> <span class="n">csrf</span><span class="o">=</span><span class="n">R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa</span><span class="o">&amp;</span><span class="n">email</span><span class="o">=</span><span class="n">wiener</span><span class="nd">@normal</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>In this situation, the attacker can again perform a CSRF attack if the web site contains any cookie setting functionality. Here, the attacker doesn’t need to obtain a valid token of their own. They simply invent a token (perhaps in the required format, if that is being checked), leverage the cookie-setting behavior to place their cookie into the victim’s browser, and feed their token to the victim in their CSRF attack.</p>
<p><strong>LAB</strong></p>
<p>PRACTITIONER<a class="reference external" href="https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-duplicated-in-cookie">CSRF where token is duplicated in cookie</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, MirRoR4s.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>